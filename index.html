<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Velkzie Music Player</title>
  <meta name="description" content="Music Player App" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    :root { color-scheme: dark; }
    body, html { margin: 0; padding: 0; background: #0a0a0a; }

    .btn-control {
      background: linear-gradient(270deg, #7e22ce, #9333ea, #a855f7);
      background-size: 600% 600%;
      color: white; border: none; border-radius: 1rem;
      padding: 0.75rem 1rem; font-size: 1.25rem;
      animation: gradientMove 6s ease infinite;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn-control:hover { box-shadow: 0 0 15px rgba(168,85,247,.8); transform: scale(1.05); }
    @keyframes gradientMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

    /* Panels */
    #lyricsPanel {
      position: fixed; top: 0; right: -420px; width: 380px; height: 100%;
      background: rgba(20,20,30,0.95); border-left: 2px solid #4b0082;
      overflow-y: auto; padding: 1rem; transition: right .4s ease; z-index: 20;
    }
    #lyricsPanel.open { right: 0; }
    #queuePanel {
      position: fixed; top: 0; left: -420px; width: 380px; height: 100%;
      background: rgba(20,20,20,0.95); border-right: 2px solid #333;
      overflow-y: auto; padding: 1rem; transition: left .4s ease; z-index: 20;
    }
    #queuePanel.open { left: 0; }

    .queue-item {
      background: rgba(255,255,255,0.05);
      padding: .5rem .75rem;
      border-radius: .5rem;
      margin-bottom: .5rem;
      cursor: pointer;
      transition: background .18s, transform .12s, box-shadow .18s;
    }
    .queue-item:hover { background: rgba(255,255,255,0.12); }
    .queue-item.active {
      box-shadow: 0 0 0 2px rgba(168,85,247,.6);
      background: rgba(168,85,247,.08);
    }

    .pill { padding: .35rem .6rem; border-radius: .75rem; background: #1f1f23; }
    .pill:hover { background:#2a2a30; }

    /* Floating YouTube Player */
    #player {
      position: fixed;
      top: 50%;
      left: 20px;
      transform: translateY(-50%);
      width: 240px;
      height: 135px;
      border-radius: 0.75rem;
      overflow: hidden;
      background: #000;
      z-index: 100;
    }
    #player.hidden { display: none; }
    #player iframe { width: 100%; height: 100%; }
  </style>
</head>
<body class="bg-neutral-950 text-neutral-100 min-h-screen relative">
  <div class="relative z-10 max-w-6xl mx-auto p-4 md:p-8">
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="text-3xl md:text-4xl font-black tracking-tight">Velkzie Music Player</h1>
        <p class="text-neutral-400">YouTube ‚Ä¢ Queue ‚Ä¢ Lyrics ‚Ä¢ Faves ‚Ä¢ Stats</p>
      </div>
      <div class="flex gap-2 flex-wrap">
        <button id="btnQueue" class="px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700">üìñ Queue</button>
        <button id="btnLyrics" class="px-3 py-2 rounded-xl bg-purple-700 hover:bg-purple-600">Lyrics</button>
        <button id="btnFaves" class="px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700">‚≠ê Faves</button>
        <button id="btnStats" class="px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700">üìä Stats</button>
        <button id="btnImport" class="px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700">üì• Import</button>
        <button id="btnExport" class="px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700">üì§ Export</button>
        <button id="btnShare" class="px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700">üîó Share</button>
        <button id="btnToggleVideo" class="px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700">üé• Hide Video</button>
        <input id="fileImport" type="file" accept="application/json,.json,.lrc,.txt" class="hidden" />
      </div>
    </header>

    <section class="mt-6">
      <input id="youtubeInput" placeholder="Paste YouTube URL here" class="w-full px-4 py-3 rounded-2xl bg-neutral-900 border border-neutral-800 outline-none" />
      <div class="flex gap-2 mt-2">
        <button id="btnAddToQueue" class="px-4 py-2 rounded-xl bg-red-600 text-white">Add to Queue</button>
        <button id="btnPasteLRC" class="px-4 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700">Import LRC to Lyrics</button>
      </div>
    </section>

    <section class="mt-6 p-4 rounded-3xl bg-neutral-900/70 border border-neutral-800 shadow-xl backdrop-blur">
      <div class="flex items-center gap-4">
        <img id="coverArt" alt="Cover" class="w-24 h-24 rounded-2xl object-cover bg-neutral-800" />
        <div class="min-w-0 flex-1">
          <div class="flex items-center gap-3">
            <div id="nowTitle" class="text-xl font-bold truncate flex-1">‚Äî</div>
            <button id="btnFavToggle" class="pill">‚≠ê</button>
          </div>
          <div class="text-sm text-neutral-400 mt-1" id="nowInfo">‚Äî</div>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-2 flex-wrap">
        <button id="btnPrev" class="btn-control">‚èÆÔ∏è</button>
        <button id="btnPlay" class="btn-control">‚ñ∂</button>
        <button id="btnNext" class="btn-control">‚è≠Ô∏è</button>
        <button id="btnShuffle" class="btn-control">üîÄ</button>
        <button id="btnRepeat" class="btn-control">üîÅ</button>
      </div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="text-sm text-neutral-400">Volume</label>
          <input id="vol" type="range" min="0" max="100" value="100" class="w-full" />
        </div>
        <div>
          <label class="text-sm text-neutral-400">Speed</label>
          <input id="speed" type="range" min="0.5" max="2" step="0.1" value="1" class="w-full" />
        </div>
        <div class="flex items-end">
          <button id="resetSpeed" class="px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700 w-full">Reset Speed</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Floating Video Player -->
  <div id="player"></div>

  <!-- Panels -->
  <div id="lyricsPanel">
    <h2 class="text-2xl font-bold mb-4">Lyrics</h2>
    <p class="text-neutral-400">No lyrics loaded yet.</p>
  </div>
  <div id="queuePanel">
    <h2 class="text-2xl font-bold mb-4">Queue</h2>
    <p id="emptyQueueMsg" class="text-neutral-400">Your queue is empty.</p>
    <div id="queueList" class="text-neutral-300 mt-2"></div>
  </div>

  <script>
    // ======= STATE =======
    let player = null;
    let playerReady = false;
    let queue = []; // { title, videoId, url }
    let currentIndex = -1;
    let isPlaying = false;
    let shuffle = false;
    let repeat = false;
    let deferredIndex = null; // play after player ready

    // ======= HELPERS =======
    function $(id){ return document.getElementById(id); }

    // Robust YouTube ID extractor (watch, youtu.be, embed, shorts, /v/, etc.)
    function extractVideoID(input) {
      try {
        // If user pasted just an ID
        if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;

        const url = new URL(input);
        // Standard watch?v=ID
        const v = url.searchParams.get('v');
        if (v && /^[a-zA-Z0-9_-]{11}$/.test(v)) return v;

        // Shorts /shorts/ID
        const shorts = url.pathname.match(/\/shorts\/([a-zA-Z0-9_-]{11})/);
        if (shorts) return shorts[1];

        // youtu.be/ID, /embed/ID, /v/ID
        const pathID = url.pathname.match(/(?:\/embed\/|\/v\/|\/)([a-zA-Z0-9_-]{11})/);
        if (pathID) return pathID[1];

        return null;
      } catch {
        // Not a URL, maybe raw ID
        return /^[a-zA-Z0-9_-]{11}$/.test(input) ? input : null;
      }
    }

    // Safe title fetch with fallback (noembed supports CORS)
    async function fetchTitle(videoId) {
      try {
        const r = await fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${videoId}`);
        const d = await r.json();
        if (d && d.title) return d.title;
      } catch (_) {}
      return `YouTube Video (${videoId})`;
    }

    function updateNowPlayingUI(song, index) {
      $('nowTitle').textContent = song ? song.title : '‚Äî';
      $('nowInfo').textContent = song ? `Playing from queue (${index + 1}/${queue.length})` : '‚Äî';
      $('coverArt').src = song ? `https://i.ytimg.com/vi/${song.videoId}/hqdefault.jpg` : '';
    }

    function updateQueueUI() {
      const list = $('queueList');
      const empty = $('emptyQueueMsg');
      list.innerHTML = "";

      if (queue.length === 0) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';

      queue.forEach((song, idx) => {
        const item = document.createElement('div');
        item.className = 'queue-item';
        if (idx === currentIndex) item.classList.add('active');
        item.innerHTML = `
          <div class="font-semibold truncate">${song.title}</div>
          <div class="text-xs text-neutral-400 truncate">ID: ${song.videoId}</div>
        `;
        item.addEventListener('click', () => playVideoAt(idx));
        list.appendChild(item);
      });
    }

    async function addToQueueFromInput() {
      const input = $('youtubeInput');
      const raw = input.value.trim();
      if (!raw) { alert("Please paste a YouTube URL or video ID."); return; }

      const videoId = extractVideoID(raw);
      if (!videoId) { alert("Couldn't parse that YouTube URL/ID."); return; }

      const title = await fetchTitle(videoId);
      const song = { title, videoId, url: raw };
      queue.push(song);
      updateQueueUI();
      input.value = "";

      if (currentIndex === -1) playVideoAt(0); // auto-start first add
    }

    function playVideoAt(index) {
      if (!queue[index]) return;
      currentIndex = index;
      const song = queue[index];

      updateNowPlayingUI(song, index);
      updateQueueUI(); // highlight active

      // If player isn't ready yet, defer
      if (!playerReady || !player || typeof player.loadVideoById !== 'function') {
        deferredIndex = index;
        return;
      }

      player.loadVideoById(song.videoId);
      isPlaying = true;
      $('btnPlay').textContent = '‚è∏Ô∏è';
      // apply current sliders
      try { player.setVolume(parseInt($('vol').value, 10)); } catch(_){}
      try { player.setPlaybackRate(parseFloat($('speed').value)); } catch(_){}
    }

    function playNext() {
      if (queue.length === 0) return;
      if (shuffle) {
        const next = Math.floor(Math.random() * queue.length);
        playVideoAt(next);
      } else if (currentIndex < queue.length - 1) {
        playVideoAt(currentIndex + 1);
      } else if (repeat) {
        playVideoAt(0);
      } else {
        isPlaying = false;
        $('btnPlay').textContent = '‚ñ∂';
      }
    }

    function playPrev() {
      if (currentIndex > 0) playVideoAt(currentIndex - 1);
    }

    // ======= YOUTUBE PLAYER =======
    window.onYouTubeIframeAPIReady = function() {
      player = new YT.Player('player', {
        height: '135',
        width: '240',
        videoId: '',
        playerVars: { playsinline: 1 },
        events: {
          onReady: () => {
            playerReady = true;
            // If something was selected before player was ready, play it now
            if (deferredIndex !== null) {
              const idx = deferredIndex;
              deferredIndex = null;
              playVideoAt(idx);
            }
          },
          onStateChange: (e) => {
            if (e.data === YT.PlayerState.ENDED) {
              if (repeat) player.playVideo(); else playNext();
            }
          }
        }
      });
    };

    // ======= UI WIRING =======
    // Panels
    $('btnQueue').addEventListener('click', () => {
      $('queuePanel').classList.toggle('open');
      $('lyricsPanel').classList.remove('open');
    });
    $('btnLyrics').addEventListener('click', () => {
      $('lyricsPanel').classList.toggle('open');
      $('queuePanel').classList.remove('open');
    });

    // Add to queue (no inline onclick anymore)
    $('btnAddToQueue').addEventListener('click', addToQueueFromInput);
    $('youtubeInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addToQueueFromInput();
    });

    // Playback
    $('btnPlay').addEventListener('click', () => {
      if (!player || currentIndex === -1) return;
      if (isPlaying) {
        player.pauseVideo();
        $('btnPlay').textContent = '‚ñ∂';
      } else {
        player.playVideo();
        $('btnPlay').textContent = '‚è∏Ô∏è';
      }
      isPlaying = !isPlaying;
    });
    $('btnNext').addEventListener('click', playNext);
    $('btnPrev').addEventListener('click', playPrev);

    $('btnShuffle').addEventListener('click', () => {
      shuffle = !shuffle;
      $('btnShuffle').style.opacity = shuffle ? '1' : '0.6';
    });
    $('btnRepeat').addEventListener('click', () => {
      repeat = !repeat;
      $('btnRepeat').style.opacity = repeat ? '1' : '0.6';
    });

    // Volume & Speed
    $('vol').addEventListener('input', () => {
      try { if (player && playerReady) player.setVolume(parseInt($('vol').value, 10)); } catch(_){}
    });
    $('speed').addEventListener('input', () => {
      try { if (player && playerReady) player.setPlaybackRate(parseFloat($('speed').value)); } catch(_){}
    });
    $('resetSpeed').addEventListener('click', () => {
      $('speed').value = 1;
      try { if (player && playerReady) player.setPlaybackRate(1); } catch(_){}
    });

    // Faves (simple toggle for current song)
    const faves = [];
    $('btnFavToggle').addEventListener('click', () => {
      if (currentIndex === -1) return;
      const id = queue[currentIndex].videoId;
      const i = faves.indexOf(id);
      if (i === -1) {
        faves.push(id);
        $('btnFavToggle').textContent = '‚≠ê Faved';
        $('btnFavToggle').classList.add('bg-yellow-500');
      } else {
        faves.splice(i, 1);
        $('btnFavToggle').textContent = '‚≠ê';
        $('btnFavToggle').classList.remove('bg-yellow-500');
      }
    });

    // Import / Export / Share / Stats / Show-Hide video
    $('btnImport').addEventListener('click', () => $('fileImport').click());
    $('fileImport').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      try {
        const data = JSON.parse(text);
        if (Array.isArray(data.queue)) {
          queue = data.queue.filter(x => x && x.videoId);
          currentIndex = -1;
          updateQueueUI();
          $('emptyQueueMsg').style.display = queue.length ? 'none' : 'block';
          alert('Imported queue from JSON.');
        } else {
          alert('Invalid JSON format.');
        }
      } catch {
        alert('Not valid JSON.');
      }
      e.target.value = '';
    });

    $('btnExport').addEventListener('click', () => {
      const data = JSON.stringify({ queue }, null, 2);
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "velkzie_music_data.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    $('btnStats').addEventListener('click', () => {
      alert(`üìä Stats:
Songs in queue: ${queue.length}
Current index: ${currentIndex === -1 ? 'none' : currentIndex + 1}
Shuffle: ${shuffle}
Repeat: ${repeat}`);
    });

    $('btnShare').addEventListener('click', async () => {
      const shareData = { title: "Velkzie Music Player", text: "Check out this player!", url: location.href };
      try { await navigator.share(shareData); }
      catch { await navigator.clipboard.writeText(location.href); alert('Link copied to clipboard!'); }
    });

    $('btnToggleVideo').addEventListener('click', () => {
      const el = $('player');
      el.classList.toggle('hidden');
      $('btnToggleVideo').textContent = el.classList.contains('hidden') ? 'üé• Show Video' : 'üé• Hide Video';
    });

    // Initial UI paint
    updateQueueUI();
    updateNowPlayingUI(null, -1);
  </script>
</body>
</html>
